<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hamza Repair Slip</title>
    <meta name="theme-color" content="#222222">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            background-color: #e6e6e6;
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            width: 100%;
            overflow-x: hidden;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px 0;
            }
        }

        /* --- Main Paper --- */
        .slip-container {
            width: 850px;
            background-color: #fff;
            padding: 10px 30px 20px 30px;
            box-sizing: border-box;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid #ccc;
        }

        /* --- Header Section --- */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            margin-top: 10px;
        }

        /* The Rounded Box containing Title + Contact */
        .header-box {
            width: 78%; /* Leaves space for the badge on the right */
            border: 3px solid #222;
            border-radius: 25px;
            padding: 10px 15px;
            display: flex;
            flex-direction: column;
        }

        .header-title-row {
            text-align: center;
            margin-bottom: 10px;
        }

        h1 {
            font-family: 'Oswald', sans-serif;
            font-size: 46px; /* Slightly adjusted to fit */
            text-transform: uppercase;
            margin: 0;
            letter-spacing: 1px;
            color: #222;
            line-height: 1;
        }

        .sub-title {
            font-weight: bold;
            font-size: 16px;
            margin-top: 2px;
            color: #333;
            text-align: center;
        }

        /* Info Row: Address + Phones */
        .header-info-row {
            display: flex;
            justify-content: flex-start; 
            align-items: flex-start;
            margin-top: 5px;
        }

        .info-left {
            font-size: 13px;
            font-weight: 700;
            line-height: 1.3;
            width: 40%;
        }

        .info-right {
            text-align: left;
            width: 60%;
            padding-left: 10px;
        }

        .phone-text {
            font-size: 20px; 
            font-weight: 900;
            line-height: 1.4;
            color: #000;
        }

        /* Right Side: Badge + Stamp (OUTSIDE the border) */
        .header-side {
            width: 20%;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            position: relative;
        }

        .repair-badge {
            background-color: #222;
            color: #fff;
            padding: 5px 10px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 10px;
            font-family: 'Oswald', sans-serif;
            border: 2px solid #222;
            white-space: nowrap;
        }
        
        .stamp-number {
            margin-top: 40px; /* Push it down */
            margin-right: 10px;
            color: #cc3333;
            font-family: 'Courier New', monospace;
            font-size: 26px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* --- Customer Inputs (Rows aligned) --- */
        .details-table {
            width: 100%;
            margin-bottom: 10px;
            border-collapse: collapse;
        }
        .details-row {
            display: flex;
            width: 100%;
            margin-bottom: 5px;
        }
        
        /* Column for Name/Address */
        .col-detail-left {
            width: 65%;
            display: flex;
            align-items: flex-end;
            padding-right: 20px;
        }
        
        /* Column for Date/Tel No */
        .col-detail-right {
            width: 35%;
            display: flex;
            align-items: flex-end;
        }

        .input-label {
            white-space: nowrap;
            margin-right: 5px;
            font-weight: bold;
            font-size: 15px;
            font-family: 'Arial', sans-serif;
        }

        input[type="text"] {
            border: none;
            border-bottom: 2px dashed #444;
            background: transparent;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            color: #000 !important;
            -webkit-text-fill-color: #000 !important;
            font-weight: 700;
            padding: 0 5px;
            outline: none;
            flex-grow: 1;
            width: 100%;
        }

        /* --- Grid System --- */
        :root {
            /* Fixed widths to ensure vertical line alignment across separate blocks */
            --grid-left: 78%; 
            --grid-right: 22%;
        }

        /* Style for the Rounded "Pill" Rows */
        .rounded-grid-row {
            border: 2px solid #000;
            border-radius: 25px; /* Fully rounded ends */
            height: 45px;
            display: flex;
            overflow: hidden; /* clip contents */
            margin-bottom: 6px; /* Space between rows */
        }

        /* Style for the Square Block (Desc/Total) */
        .square-grid-block {
            border: 2px solid #000;
            /* No border radius */
            display: flex;
            flex-direction: column;
        }

        /* Inner Layout for Grid Rows */
        .panel-left {
            width: var(--grid-left);
            border-right: 2px solid #000; /* Vertical Line */
            display: flex;
            align-items: center;
            padding-left: 15px;
            padding-right: 10px;
            box-sizing: border-box;
        }

        .panel-right {
            width: var(--grid-right);
            display: flex;
            align-items: center;
        }

        /* Labels inside grid */
        .grid-lbl-start {
            font-weight: 900;
            font-size: 18px;
            text-transform: uppercase;
            margin-right: 10px;
        }

        .grid-lbl-end {
            font-weight: 900;
            font-size: 18px;
            text-transform: uppercase;
            margin-left: auto; /* Pushes to right */
            margin-right: 5px; /* Space before vertical line */
        }

        .clean-input {
            width: 100%;
            height: 100%;
            border: none !important;
            background: transparent;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            color: #000 !important;
            -webkit-text-fill-color: #000 !important;
            font-weight: 700;
            padding-left: 10px;
        }

        input[type="text"]::placeholder,
        .clean-input::placeholder {
            color: #000;
            opacity: 1;
        }

        input[type="text"]:-webkit-autofill,
        input[type="text"]:-webkit-autofill:hover,
        input[type="text"]:-webkit-autofill:focus,
        input[type="text"]:-webkit-autofill:active {
            -webkit-text-fill-color: #000 !important;
            box-shadow: 0 0 0px 1000px transparent inset;
            transition: background-color 9999s ease-out 0s;
        }

        /* Description Rows */
        .desc-row {
            display: flex;
            height: 35px;
            border-bottom: 2px solid #000;
        }
        .desc-row:last-child {
            border-bottom: none; /* For the last item inside container */
        }

        /* Checklist */
        .checklist-container {
            display: flex;
            align-items: center;
        }
        .check-item {
            display: flex;
            align-items: center;
            margin-right: 10px;
            font-weight: 900;
            font-size: 14px;
        }
        .box-square {
            width: 20px;
            height: 20px;
            border: 2px solid #000;
            margin-left: 3px;
            cursor: pointer;
            text-align: center;
            line-height: 20px;
            font-size: 16px;
        }

        /* --- Footer --- */
        .footer-terms {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 10px;
            line-height: 1.25;
            font-weight: 700;
        }
        .col-terms { width: 48%; }

        /* Controls */
        .controls { margin-top: 20px; }
        button {
            padding: 12px 24px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover { background-color: #1a252f; }

        #slip-scale {
            transform-origin: top left;
        }

        @media (max-width: 900px) {
            #slip-scale {
                transform-origin: top center;
            }
        }

        .today-btn {
            margin-left: 8px;
            padding: 6px 10px;
            font-size: 12px;
            background-color: #222;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        .signature-block {
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .signature-label {
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
        }

        .signature-canvas {
            border-bottom: 2px dotted #222;
            width: 520px;
            height: 60px;
            touch-action: none;
            background: transparent;
        }

        .signature-controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .signature-btn {
            padding: 6px 10px;
            font-size: 12px;
            background-color: #444;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .signature-remove {
            padding: 6px 10px;
            font-size: 12px;
            background-color: #aa2222;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .signature-upload {
            font-size: 12px;
        }

        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>

    <div id="slip-scale">
    <div class="slip-container" id="repair-slip">
        
        <!-- Header -->
        <div class="header-section">
            <!-- Box Content -->
            <div class="header-box">
                <div class="header-title-row">
                    <h1>HAMZA CELL & COMPUTERS</h1>
                    <div class="sub-title">Cellphones And Laptop Repairs & Accessories</div>
                </div>
                <div class="header-info-row">
                    <div class="info-left">
                        Shop No: 3 Pick N Pay Complex<br>
                        Oxford Street<br>
                        Southern Wood<br>
                        East London
                    </div>
                    <div class="info-right">
                        <div class="phone-text">Shop No: 067 961 0666</div>
                        <div class="phone-text">Whatsapp No: 067 226 3344</div>
                    </div>
                </div>
            </div>
            <!-- Outside Side Content -->
            <div class="header-side">
                <div class="repair-badge">REPAIR SLIP</div>
                <div class="stamp-number"></div>
            </div>
        </div>

        <!-- Customer Details: Aligned Rows -->
        <div class="details-table">
            <!-- Row 1 -->
            <div class="details-row">
                <div class="col-detail-left">
                    <div class="input-label">Name:</div>
                    <input type="text" id="name-field">
                </div>
                <div class="col-detail-right">
                    <div class="input-label" style="width: 60px;">Date:</div>
                    <input type="text" id="date-field">
                    <button class="today-btn no-print" data-html2canvas-ignore="true" type="button" onclick="setToday()">Today</button>
                </div>
            </div>
            <!-- Row 2 -->
            <div class="details-row">
                <div class="col-detail-left">
                    <div class="input-label">Address:</div>
                    <input type="text">
                </div>
                <div class="col-detail-right">
                    <div class="input-label" style="width: 60px;">Tel No:</div>
                    <input type="text" id="tel-field">
                </div>
            </div>
        </div>

        <!-- GRID SYSTEM -->

        <!-- 1. Rounded Row: FAULT / MODEL -->
        <div class="rounded-grid-row">
            <div class="panel-left">
                <div class="grid-lbl-start">FAULT:</div>
                <input type="text" style="border:none; border-bottom: 2px dashed #ccc; width: 50%;">
                
                <!-- MODEL on left of line -->
                <div class="grid-lbl-end">MODEL:</div>
            </div>
            <div class="panel-right">
                <input type="text" class="clean-input">
            </div>
        </div>

        <!-- 2. Rounded Row: IMEI / MAKE -->
        <div class="rounded-grid-row">
            <div class="panel-left">
                <div class="grid-lbl-start">IMEI No:</div>
                <input type="text" style="border:none; border-bottom: 2px dashed #ccc; width: 50%;">
                
                <!-- MAKE on left of line -->
                <div class="grid-lbl-end">MAKE:</div>
            </div>
            <div class="panel-right">
                <input type="text" class="clean-input">
            </div>
        </div>

        <!-- 3. Square Block: Description + Total -->
        <div class="square-grid-block">
            <!-- Desc Line 1 -->
            <div class="desc-row">
                <div class="panel-left">
                    <input type="text" class="clean-input">
                </div>
                <div class="panel-right">
                    <input type="text" class="clean-input" style="border-bottom: 2px solid #000;">
                </div>
            </div>
            <!-- Desc Line 2 -->
            <div class="desc-row">
                <div class="panel-left">
                    <input type="text" class="clean-input">
                </div>
                <div class="panel-right">
                    <input type="text" class="clean-input" style="border-bottom: 2px solid #000;">
                </div>
            </div>
            <!-- Desc Line 3 -->
            <div class="desc-row">
                <div class="panel-left">
                    <input type="text" class="clean-input">
                </div>
                <div class="panel-right">
                    <input type="text" class="clean-input" style="border-bottom: 2px solid #000;">
                </div>
            </div>

            <!-- Checkbox + Total Row -->
            <div class="desc-row" style="height: 40px; border-bottom: none;">
                <div class="panel-left">
                    <div class="checklist-container">
                        <div class="check-item">SIM <div class="box-square" onclick="toggleX(this)"></div></div>
                        <div class="check-item">BATTERY <div class="box-square" onclick="toggleX(this)"></div></div>
                        <div class="check-item">M/CARD <div class="box-square" onclick="toggleX(this)"></div></div>
                        <div class="check-item">BACK COVER <div class="box-square" onclick="toggleX(this)"></div></div>
                    </div>

                    <!-- TOTAL on left of line -->
                    <div class="grid-lbl-end">TOTAL</div>
                </div>
                <div class="panel-right">
                    <input type="text" class="clean-input">
                </div>
            </div>
        </div>

        <!-- Terms Footer -->
        <div class="footer-terms">
            <div class="col-terms">
                (1) No Cash Refund<br>
                (2) All repairs not collected within 30 days will be sold to defray costs.<br>
                (3) No guarantee on water damaged, LCD Network & Software Problems<br>
                (4) We are NOT responsible for fire, theft or damage during repairs<br>
                (5) Items shall only be released upon presentation of this slip
            </div>
            <div class="col-terms">
                <div style="text-align: right; margin-bottom: 2px;">PRINTER: 073 333 6308</div>
                (6) All Repairs Are Left At Owner's Risk<br>
                (7) Not responsible if IMEI differs or is blacklisted or for loss of data during repairs.<br>
                (8) Repairs under R200 will be carried out automatically<br>
                (9) No Guarantee For Lcd & Touch
            </div>
        </div>

        <div style="margin-top: 15px; font-weight: bold; font-size: 14px;">
            <div class="signature-block">
                <div class="signature-label">Signature</div>
                <canvas id="signature-canvas" class="signature-canvas"></canvas>
                <div class="signature-controls no-print" data-html2canvas-ignore="true">
                    <button type="button" class="signature-btn" onclick="clearSignature()">Clear</button>
                    <button type="button" class="signature-remove" onclick="removeSignatureImage()">X</button>
                    <input type="file" id="signature-upload" class="signature-upload" accept="image/*" capture="environment">
                </div>
            </div>
        </div>

    </div>
    </div>

    <div class="controls">
        <button onclick="savePDF()">Save as PDF</button>
        <button onclick="sharePDF()">Share PDF</button>
    </div>

    <script>
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function setToday() {
            document.getElementById('date-field').value = formatDate(new Date());
        }

        function updateScale() {
            const wrapper = document.getElementById('slip-scale');
            const slip = document.getElementById('repair-slip');

            // Use the body's content width, which respects CSS padding.
            // Subtract a small amount for breathing room on mobile.
            const breathingRoom = window.innerWidth < 900 ? 20 : 0; // Creates a 10px margin on each side
            const availableWidth = document.body.clientWidth - breathingRoom;
            const scale = Math.min(1, availableWidth / slip.offsetWidth);

            wrapper.style.transform = `scale(${scale})`;
        }

        function saveData() {
            const inputs = Array.from(document.querySelectorAll('.slip-container input[type="text"]')).map(i => i.value);
            const checks = Array.from(document.querySelectorAll('.box-square')).map(i => i.innerHTML);
            const signature = document.getElementById('signature-canvas').toDataURL();
            
            const data = { inputs, checks, signature };
            localStorage.setItem('repair_slip_data', JSON.stringify(data));
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('repair_slip_data'));
            if (!data) return;

            const inputs = document.querySelectorAll('.slip-container input[type="text"]');
            data.inputs.forEach((val, i) => { if (inputs[i]) inputs[i].value = val; });

            const checks = document.querySelectorAll('.box-square');
            data.checks.forEach((val, i) => { if (checks[i]) checks[i].innerHTML = val; });

            if (data.signature && data.signature.length > 20) {
                const img = new Image();
                img.onload = () => document.getElementById('signature-canvas').getContext('2d').drawImage(img, 0, 0);
                img.src = data.signature;
            }
        }

        function setupSignatureCanvas() {
            const canvas = document.getElementById('signature-canvas');
            if (canvas.dataset.ready === 'true') return;

            const ctx = canvas.getContext('2d');
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#111';

            let drawing = false;

            function getPoint(e) {
                const rect = canvas.getBoundingClientRect();
                if (e.touches && e.touches[0]) {
                    return {
                        x: e.touches[0].clientX - rect.left,
                        y: e.touches[0].clientY - rect.top
                    };
                }
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }

            function start(e) {
                drawing = true;
                const p = getPoint(e);
                ctx.beginPath();
                ctx.moveTo(p.x, p.y);
                e.preventDefault();
            }

            function draw(e) {
                if (!drawing) return;
                const p = getPoint(e);
                ctx.lineTo(p.x, p.y);
                ctx.stroke();
                e.preventDefault();
            }

            function stop(e) {
                drawing = false;
                saveData();
                e.preventDefault();
            }

            canvas.addEventListener('pointerdown', start);
            canvas.addEventListener('pointermove', draw);
            canvas.addEventListener('pointerup', stop);
            canvas.addEventListener('pointerleave', stop);
            canvas.addEventListener('touchstart', start, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stop, { passive: false });

            const upload = document.getElementById('signature-upload');
            upload.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);
                        const scale = Math.min(canvas.offsetWidth / img.width, canvas.offsetHeight / img.height);
                        const w = img.width * scale;
                        const h = img.height * scale;
                        const x = (canvas.offsetWidth - w) / 2;
                        const y = (canvas.offsetHeight - h) / 2;
                        ctx.drawImage(img, x, y, w, h);
                        saveData();
                    };
                    img.src = reader.result;
                };
                reader.readAsDataURL(file);
            });

            canvas.dataset.ready = 'true';
        }

        function resizeSignatureCanvas() {
            const canvas = document.getElementById('signature-canvas');
            const ratio = window.devicePixelRatio || 1;
            const newWidth = Math.floor(canvas.offsetWidth * ratio);
            const newHeight = Math.floor(canvas.offsetHeight * ratio);
            
            if (canvas.width === newWidth && canvas.height === newHeight) return;

            // Save current content before resizing
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            if (canvas.width > 0 && canvas.height > 0) {
                tempCanvas.getContext('2d').drawImage(canvas, 0, 0);
            }

            canvas.width = newWidth;
            canvas.height = newHeight;

            const ctx = canvas.getContext('2d');
            ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#111';

            // Restore content
            if (tempCanvas.width > 0) ctx.drawImage(tempCanvas, 0, 0, newWidth / ratio, newHeight / ratio);
        }

        function clearSignature() {
            const canvas = document.getElementById('signature-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);
            saveData();
        }

        function removeSignatureImage() {
            clearSignature();
            const upload = document.getElementById('signature-upload');
            upload.value = '';
            saveData();
        }

        setToday();
        window.addEventListener('resize', () => {
            updateScale();
            resizeSignatureCanvas();
        });
        updateScale();
        setupSignatureCanvas();
        resizeSignatureCanvas();
        loadData(); // Load saved data on startup

        // Auto-save on any text input change
        document.querySelector('.slip-container').addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT') saveData();
        });

        function toggleX(el) {
            el.innerHTML = el.innerHTML === "X" ? "" : "X";
            saveData();
        }

        function sanitizeFilename(text) {
            return text
                .replace(/[\\/:*?"<>|]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function buildPdfBlob(filename) {
            const element = document.getElementById('repair-slip');
            const wrapper = document.getElementById('slip-scale');
            const prevTransform = wrapper.style.transform;
            wrapper.style.transform = 'none';

            const width = Math.ceil(element.scrollWidth);
            const height = Math.ceil(element.scrollHeight);

            return html2canvas(element, {
                scale: 2,
                scrollX: 0,
                scrollY: 0,
                width: width,
                height: height,
                windowWidth: width,
                windowHeight: height,
                backgroundColor: '#ffffff',
                useCORS: true
            }).then((canvas) => {
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const pdf = new window.jspdf.jsPDF({
                    unit: 'px',
                    format: [canvas.width, canvas.height],
                    orientation: canvas.width > canvas.height ? 'landscape' : 'portrait'
                });
                pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
                const blob = pdf.output('blob');
                return { blob, filename };
            }).finally(() => {
                wrapper.style.transform = prevTransform;
                updateScale();
            });
        }

        function savePDF() {
            const nameValue = sanitizeFilename(document.getElementById('name-field').value || 'Customer');
            const telValue = sanitizeFilename(document.getElementById('tel-field').value || 'No');
            const dateValue = sanitizeFilename((document.getElementById('date-field').value || formatDate(new Date())).replace(/\//g, '-'));
            const filename = `${nameValue} ${telValue} ${dateValue}.pdf`;

            buildPdfBlob(filename).then(({ blob, filename }) => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                URL.revokeObjectURL(link.href);
                link.remove();
            });
        }

        async function sharePDF() {
            const nameValue = sanitizeFilename(document.getElementById('name-field').value || 'Customer');
            const telValue = sanitizeFilename(document.getElementById('tel-field').value || 'No');
            const dateValue = sanitizeFilename((document.getElementById('date-field').value || formatDate(new Date())).replace(/\//g, '-'));
            const filename = `${nameValue} ${telValue} ${dateValue}.pdf`;

            try {
                const result = await buildPdfBlob(filename);
                const file = new File([result.blob], filename, { type: 'application/pdf' });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: 'Repair Slip',
                        text: 'Repair slip PDF',
                        files: [file]
                    });
                } else if (navigator.share) {
                    await navigator.share({
                        title: 'Repair Slip',
                        text: 'Repair slip PDF'
                    });
                    savePDF();
                } else {
                    savePDF();
                }
            } catch (err) {
                savePDF();
            }
        }
    </script>
    <script type="module" src="/src/main.js"></script>
</body>
</html>
